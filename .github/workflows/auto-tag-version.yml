name: Auto-Tag Version

# Automatically creates a git tag when VERSION file changes on main branch
# This ensures version bumps are properly tagged for release tracking

on:
  push:
    branches:
      - main
    paths:
      - 'VERSION'

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to check if VERSION changed

      - name: Check if VERSION was actually modified
        id: version_check
        run: |
          # Get the VERSION from current commit
          CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "Current version: $CURRENT_VERSION"

          # Check if this is a version bump commit (not just file touch)
          if git diff HEAD~1 --name-only | grep -q "^VERSION$"; then
            PREVIOUS_VERSION=$(git show HEAD~1:VERSION 2>/dev/null | tr -d '[:space:]' || echo "")
            echo "Previous version: $PREVIOUS_VERSION"

            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
              echo "✅ Version changed from $PREVIOUS_VERSION to $CURRENT_VERSION"
            else
              echo "version_changed=false" >> $GITHUB_OUTPUT
              echo "⚠️ VERSION file touched but value unchanged"
            fi
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
            echo "⚠️ VERSION file not in diff"
          fi

      - name: Check if tag already exists
        id: tag_check
        if: steps.version_check.outputs.version_changed == 'true'
        run: |
          TAG_NAME="v${{ steps.version_check.outputs.new_version }}"
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG_NAME}$"; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "⚠️ Tag $TAG_NAME already exists"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "✅ Tag $TAG_NAME does not exist yet"
          fi

      - name: Create and push tag
        if: steps.version_check.outputs.version_changed == 'true' && steps.tag_check.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ steps.version_check.outputs.new_version }}"
          TAG_NAME="v${VERSION}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Extract release notes from CHANGELOG.md if available
          # Note: If CHANGELOG doesn't have a [X.Y.Z] section yet, tag will be created
          # without release notes. This is fine - notes can be added manually in GitHub.
          # Best practice: Update CHANGELOG before pushing version bumps to main.
          RELEASE_NOTES=""
          if [ -f "CHANGELOG.md" ]; then
            # Extract the section for this version (between ## [version] and next ## [)
            RELEASE_NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md | head -50)
          fi

          # Create annotated tag
          if [ -n "$RELEASE_NOTES" ]; then
            git tag -a "${TAG_NAME}" -m "Release ${VERSION}" -m "" -m "${RELEASE_NOTES}"
          else
            git tag -a "${TAG_NAME}" -m "Release ${VERSION}"
          fi

          # Push tag
          git push origin "${TAG_NAME}"

          echo "✅ Created and pushed tag: ${TAG_NAME}"

      - name: Summary
        if: always()
        run: |
          echo "## Version Tag Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.version_check.outputs.version_changed }}" == "true" ]; then
            if [ "${{ steps.tag_check.outputs.tag_exists }}" == "true" ]; then
              echo "⚠️ Tag v${{ steps.version_check.outputs.new_version }} already exists" >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ Created tag: v${{ steps.version_check.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ℹ️ No version change detected" >> $GITHUB_STEP_SUMMARY
          fi
