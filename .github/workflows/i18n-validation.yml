name: Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Ritualist/**/*.swift'
      - 'Ritualist/Resources/**'
      - 'Ritualist.xcodeproj/**'
      - 'TestPlan.xctestplan'
  pull_request:
    branches: [ main ]
    paths:
      - 'Ritualist/**/*.swift'
      - 'Ritualist/Resources/**'
      - 'Ritualist.xcodeproj/**'
      - 'TestPlan.xctestplan'

jobs:
  string-validation:
    name: Validate Localized Strings
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Validate String Lengths
      run: swift Scripts/validate_strings.swift
      
    - name: Upload String Validation Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: string-validation-report
        path: string_validation_report.txt
        retention-days: 30

  build-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Cache SwiftPM Dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swiftpm-${{ hashFiles('**/Package.swift', '**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swiftpm-
    
    - name: Cache Xcode DerivedData
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-deriveddata-${{ hashFiles('Ritualist.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-deriveddata-
    
    - name: Build Project (with timing)
      run: |
        echo "⏱️ Starting build at $(date)"
        BUILD_START=$(date +%s)
        
        xcodebuild build \
          -project Ritualist.xcodeproj \
          -scheme Ritualist-AllFeatures \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -configuration Debug \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "✅ Build completed in ${BUILD_TIME} seconds"
        echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
    
    - name: Run Tests (including Swift Testing)
      run: |
        echo "🧪 Starting tests at $(date)"
        TEST_START=$(date +%s)
        
        xcodebuild test \
          -project Ritualist.xcodeproj \
          -scheme Ritualist-AllFeatures \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -only-testing:RitualistTests \
          -resultBundlePath TestResults.xcresult \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData
        
        TEST_END=$(date +%s)
        TEST_TIME=$((TEST_END - TEST_START))
        echo "✅ Tests completed in ${TEST_TIME} seconds"
        echo "TEST_TIME=${TEST_TIME}" >> $GITHUB_ENV
      continue-on-error: true
      
    - name: Generate Test Coverage Report
      run: |
        # Extract basic test results
        if [ -d "TestResults.xcresult" ]; then
          echo "📊 Extracting test coverage information..."
          xcrun xccov view --report --json TestResults.xcresult > coverage.json || echo "Coverage extraction failed"
          
          # Create simple coverage report
          cat > test_coverage_report.md << 'EOF'
        # 📊 Test Coverage Report
        
        ## Build Performance
        EOF
          echo "- **Build Time**: ${BUILD_TIME} seconds" >> test_coverage_report.md
          echo "- **Test Time**: ${TEST_TIME} seconds" >> test_coverage_report.md
          echo "- **Total CI Time**: $((BUILD_TIME + TEST_TIME)) seconds" >> test_coverage_report.md
          echo "" >> test_coverage_report.md
          
          echo "## Test Results" >> test_coverage_report.md
          echo "- Test results available in TestResults.xcresult" >> test_coverage_report.md
          echo "- Generated on: $(date)" >> test_coverage_report.md
          
          echo "✅ Coverage report generated"
        else
          echo "❌ TestResults.xcresult not found - tests may have failed to run"
        fi
          
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-and-coverage
        path: |
          TestResults.xcresult/
          coverage.json
          test_coverage_report.md
        retention-days: 30

  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: |
        cd Ritualist
        swiftlint --reporter github-actions-logging

  generate-report:
    name: Generate Build Report
    runs-on: macos-latest
    needs: [string-validation, build-test, swiftlint]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Generate Build Report
      run: |
        cat > build-report.md << 'EOF'
        # 🔨 Ritualist Build Report
        
        ## Summary
        This report shows the results of the build and test pipeline for the Ritualist app.
        
        ## Pipeline Results
        - **String Validation**: ${{ needs.string-validation.result }}
        - **Build & Test**: ${{ needs.build-test.result }}
        - **SwiftLint**: ${{ needs.swiftlint.result }}
        
        ## Performance Metrics
        Build performance data available in test-results-and-coverage artifacts.
        
        ## Phase 1A Improvements
        - ✅ **Build Caching**: SwiftPM and DerivedData caching enabled
        - ✅ **Performance Tracking**: Build and test times measured
        - ✅ **Coverage Reporting**: Basic coverage data extracted
        
        ## Artifacts Available
        - `string-validation-report` - Localization validation results
        - `test-results-and-coverage` - Test results, coverage data, and performance metrics
        - `build-report` - This comprehensive report
        
        ## Next Steps
        - Review any failed builds or tests
        - Check performance trends in artifacts
        - Fix SwiftLint violations if any
        - Update string translations if validation failed
        
        Generated on: $(date)
        EOF
    
    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: |
          build-report.md
          artifacts/
        retention-days: 30
    
    - name: Comment PR (if applicable)
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('build-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

# Security: Limit permissions
permissions:
  contents: read
  issues: read
  pull-requests: write