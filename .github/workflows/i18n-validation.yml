name: Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Ritualist/**/*.swift'
      - 'Ritualist/Resources/**'
      - 'Ritualist.xcodeproj/**'
      - 'TestPlan.xctestplan'
      - '.github/workflows/**'
      - 'Scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'Ritualist/**/*.swift'
      - 'Ritualist/Resources/**'
      - 'Ritualist.xcodeproj/**'
      - 'TestPlan.xctestplan'
      - '.github/workflows/**'
      - 'Scripts/**'

jobs:
  string-validation:
    name: Validate Localized Strings
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Validate String Lengths
      run: swift Scripts/validate_strings.swift
      
    - name: Upload String Validation Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: string-validation-report
        path: string_validation_report.txt
        retention-days: 30

  build-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Cache SwiftPM Dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-swiftpm-${{ hashFiles('**/Package.swift', '**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-swiftpm-
    
    - name: Cache Xcode DerivedData
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-xcode-deriveddata-${{ hashFiles('Ritualist.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-xcode-deriveddata-
    
    - name: Build Project (with timing)
      run: |
        echo "â±ï¸ Starting build at $(date)"
        BUILD_START=$(date +%s)
        
        xcodebuild build \
          -project Ritualist.xcodeproj \
          -scheme Ritualist-AllFeatures \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -configuration Debug \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "âœ… Build completed in ${BUILD_TIME} seconds"
        echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
    
    - name: Run Tests (including Swift Testing)
      run: |
        echo "ðŸ§ª Starting tests at $(date)"
        TEST_START=$(date +%s)
        
        xcodebuild test \
          -project Ritualist.xcodeproj \
          -scheme Ritualist-AllFeatures \
          -destination 'platform=iOS Simulator,name=iPhone 16' \
          -only-testing:RitualistTests \
          -resultBundlePath TestResults.xcresult \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData
        
        TEST_END=$(date +%s)
        TEST_TIME=$((TEST_END - TEST_START))
        echo "âœ… Tests completed in ${TEST_TIME} seconds"
        echo "TEST_TIME=${TEST_TIME}" >> $GITHUB_ENV
      
    - name: Generate Test Coverage Report
      run: |
        # Extract basic test results
        if [ -d "TestResults.xcresult" ]; then
          echo "ðŸ“Š Extracting test coverage information..."
          xcrun xccov view --report --json TestResults.xcresult > coverage.json || echo "Coverage extraction failed"
          
          # Create simple coverage report
          cat > test_coverage_report.md << 'EOF'
        # ðŸ“Š Test Coverage Report
        
        ## Build Performance
        EOF
          echo "- **Build Time**: ${BUILD_TIME} seconds" >> test_coverage_report.md
          echo "- **Test Time**: ${TEST_TIME} seconds" >> test_coverage_report.md
          echo "- **Total CI Time**: $((BUILD_TIME + TEST_TIME)) seconds" >> test_coverage_report.md
          echo "" >> test_coverage_report.md
          
          echo "## Test Results" >> test_coverage_report.md
          echo "- Test results available in TestResults.xcresult" >> test_coverage_report.md
          echo "- Generated on: $(date)" >> test_coverage_report.md
          
          echo "âœ… Coverage report generated"
        else
          echo "âŒ TestResults.xcresult not found - tests may have failed to run"
        fi
          
    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-and-coverage
        path: |
          TestResults.xcresult/
          coverage.json
          test_coverage_report.md
        retention-days: 30

  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install SwiftLint
      run: brew install swiftlint
    
    - name: Run SwiftLint
      run: |
        cd Ritualist
        swiftlint --reporter github-actions-logging

  generate-report:
    name: Generate Build Report
    runs-on: macos-latest
    needs: [string-validation, build-test, swiftlint]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Generate Build Report
      run: |
        # Determine overall status
        STRING_STATUS="${{ needs.string-validation.result }}"
        BUILD_STATUS="${{ needs.build-test.result }}"
        LINT_STATUS="${{ needs.swiftlint.result }}"

        # Status emoji mapping
        get_status_emoji() {
          case $1 in
            success) echo "âœ…" ;;
            failure) echo "âŒ" ;;
            skipped) echo "âš ï¸" ;;
            *) echo "âš ï¸" ;;
          esac
        }

        STRING_EMOJI=$(get_status_emoji "$STRING_STATUS")
        BUILD_EMOJI=$(get_status_emoji "$BUILD_STATUS")
        LINT_EMOJI=$(get_status_emoji "$LINT_STATUS")

        # Check if any failures
        HAS_FAILURES=false
        if [[ "$STRING_STATUS" == "failure" ]] || [[ "$BUILD_STATUS" == "failure" ]] || [[ "$LINT_STATUS" == "failure" ]]; then
          HAS_FAILURES=true
          HEADER="# âš ï¸ CI Pipeline - Action Required"
        else
          HEADER="# âœ… CI Pipeline Results"
        fi

        # Start building report
        cat > build-report.md << EOF
        $HEADER

        ## Quality Checks
        - $STRING_EMOJI **String Validation**: $(echo $STRING_STATUS | tr '[:lower:]' '[:upper:]')
        - $BUILD_EMOJI **Build & Test**: $(echo $BUILD_STATUS | tr '[:lower:]' '[:upper:]')
        - $LINT_EMOJI **SwiftLint**: $(echo $LINT_STATUS | tr '[:lower:]' '[:upper:]')

        EOF

        # Add performance metrics if build succeeded
        if [[ "$BUILD_STATUS" == "success" ]]; then
          cat >> build-report.md << 'EOF'
        ## ðŸ“Š Performance Metrics
        Build and test performance data available in workflow artifacts.

        EOF
        fi

        # Add action required section if there are failures
        if [ "$HAS_FAILURES" = true ]; then
          cat >> build-report.md << 'EOF'
        ---

        ## ðŸš¨ Action Required

        EOF

          if [[ "$STRING_STATUS" == "failure" ]]; then
            echo "### String Validation Failed" >> build-report.md
            echo "Some localized strings exceed length constraints. Check the \`string-validation-report\` artifact for details." >> build-report.md
            echo "" >> build-report.md
          fi

          if [[ "$BUILD_STATUS" == "failure" ]]; then
            echo "### Build or Tests Failed" >> build-report.md
            echo "Review build logs and test results in the \`test-results-and-coverage\` artifact." >> build-report.md
            echo "" >> build-report.md
          fi

          if [[ "$LINT_STATUS" == "failure" ]]; then
            echo "### SwiftLint Violations" >> build-report.md
            echo "Code style violations detected. Run \`swiftlint\` locally to see and fix violations." >> build-report.md
            echo "" >> build-report.md
          fi
        fi

        # Add artifacts section
        cat >> build-report.md << 'EOF'
        ---

        ## ðŸ“¦ Artifacts
        Detailed reports available in workflow artifacts:
        - **string-validation-report** - Localization validation results
        - **test-results-and-coverage** - Test results, coverage data, and performance metrics
        - **build-report** - This comprehensive report

        EOF

        # Add timestamp
        echo "_Report generated on $(date -u '+%b %d, %Y at %H:%M:%S UTC')_" >> build-report.md
    
    - name: Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: |
          build-report.md
          artifacts/
        retention-days: 30
    
    - name: Comment PR (if applicable)
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('build-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });

# Security: Limit permissions
permissions:
  contents: read
  issues: read
  pull-requests: write